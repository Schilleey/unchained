{% extends "base_chat.html" %}

{% block control_panel %}

    <h1 id="talkingh1">You are talking with '{{ chatpartner }}' now!</h1>


	<input type="text" id="text_message" />
	<button id="send_message">Send message</button>
    <div id="billboard"></div>

{% endblock control_panel %}

{% block script_panel %}
<script type="text/javascript">
	jQuery(document).ready(function($) {
		var ws4redis = WS4Redis({
			uri: '{{ WEBSOCKET_URI }}unchained?subscribe-user&publish-user&echo',
			receive_message: receiveMessage,
			heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
		});

		// send message to the server using Ajax
		$('#send_message').click(function() {
            sendMessage();
		});

        $('#text_message').keypress(function(e){
        var code = e.keyCode || e.which;
        if(code == 13)
        {
            sendMessage();
        }
        });

		// receive a message though the Websocket from the server
		function receiveMessage(msg)
        {
			$('#billboard').append('<div id="chattextpartner">' + msg + '</div>');
		}

       var sendMessage = function(){
            var msg = '{{ username }}' + ': ' + $('#text_message').val();
           $('#billboard').append('<div id="chattextself">' + msg + '</div>');
			$.post('{% url "user_chat" %}', {
				user: '{{ chatpartner }}',
				message:  msg
			});
           $('#text_message').val('');
    }
	});
</script>
{% endblock script_panel %}
